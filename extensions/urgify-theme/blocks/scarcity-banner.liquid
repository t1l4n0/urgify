{% liquid
  # Check subscription status first
  assign subscription_active = shop.metafields.urgify.subscription_active.value | default: false
  if subscription_active != true and subscription_active != 'true'
    # No active subscription, don't render anything
    assign should_render = false
  else
    assign should_render = true
  endif
%}

{% unless should_render %}
  {% comment %}No active subscription - show subscription required message{% endcomment %}
  <div style="padding: 20px; border: 2px dashed #e74c3c; border-radius: 8px; margin: 20px 0; background: #fdf2f2; text-align: center;">
    <div style="color: #e74c3c; font-weight: bold; margin-bottom: 8px;">ğŸ”’ Subscription Required</div>
    <div style="color: #666; font-size: 14px; margin-bottom: 12px;">This block requires an active Urgify subscription to display.</div>
    <div style="color: #999; font-size: 12px;">Configure your settings below. The block will appear once you subscribe.</div>
  </div>
{% else %}

{{ 'urgify-scarcity-banner.css' | asset_url | stylesheet_tag }}

<div id="scarcity-banner-urgify-{{ block.id }}" 
     class="urgify-scarcity-banner notify-style-{{ block.settings.notify_style | default: 'spectacular' }} badge" 
     data-urgify="scarcity-banner"
     data-block-id="{{ block.id }}"
     style="--custom-bg: {{ block.settings.background_color | default: '#dc3545' }}; --custom-color: {{ block.settings.font_color | default: 'white' }};">

  
  {% if block.settings.icon != '' %}
    <span class="notification-icon">{{ block.settings.icon }}</span>
  {% endif %}
  
  <span class="notification-message">
    {{ block.settings.message | default: 'Urgent: Limited time offer ending soon!' }}
  </span>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const banner = document.getElementById('scarcity-banner-urgify-{{ block.id }}');
  if (banner && banner.classList.contains('notify-style-glassmorphism')) {
    // Function to get background color of parent container
    function getParentBackgroundColor(element) {
      let parent = element.parentElement;
      while (parent && parent !== document.body) {
        const computedStyle = window.getComputedStyle(parent);
        const bgColor = computedStyle.backgroundColor;
        
        // If background color is not transparent, return it
        if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
          return bgColor;
        }
        parent = parent.parentElement;
      }
      return 'rgba(255, 255, 255, 1)'; // Default to white
    }
    
    // Function to convert RGB to brightness value
    function getBrightness(rgb) {
      const match = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
      if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        // Calculate relative luminance
        return (r * 299 + g * 587 + b * 114) / 1000;
      }
      return 255; // Default to light
    }
    
    // Function to adjust text color based on background
    function adjustTextColor() {
      const bgColor = getParentBackgroundColor(banner);
      const brightness = getBrightness(bgColor);
      
      const message = banner.querySelector('.notification-message');
      const icon = banner.querySelector('.notification-icon');
      
      if (brightness < 128) {
        // Dark container background - use white text with stronger contrast
        banner.style.color = 'rgba(255, 255, 255, 0.98)';
        banner.style.background = 'rgba(255, 255, 255, 0.15)'; // Lighter glass background
        if (message) {
          message.style.color = 'rgba(255, 255, 255, 0.98)';
          message.style.textShadow = '0 2px 4px rgba(0, 0, 0, 0.5), 0 1px 2px rgba(0, 0, 0, 0.3)';
        }
        if (icon) {
          icon.style.color = 'rgba(255, 255, 255, 0.95)';
          icon.style.filter = 'drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5))';
        }
      } else {
        // Light container background - use dark text
        banner.style.color = '#1a1a1a';
        banner.style.background = 'rgba(255, 255, 255, 0.12)'; // Original glass background
        if (message) {
          message.style.color = '#1a1a1a';
          message.style.textShadow = '0 1px 2px rgba(255, 255, 255, 0.8)';
        }
        if (icon) {
          icon.style.color = '#2d2d2d';
          icon.style.filter = 'drop-shadow(0 1px 2px rgba(255, 255, 255, 0.6))';
        }
      }
    }
    
    // Adjust on load
    adjustTextColor();
    
    // Adjust on window resize (in case layout changes)
    window.addEventListener('resize', adjustTextColor);
    
    // Adjust when DOM changes (in case background changes)
    const observer = new MutationObserver(adjustTextColor);
    observer.observe(document.body, { 
      attributes: true, 
      attributeFilter: ['style', 'class'],
      subtree: true 
    });
  }
});
</script>

{% endunless %}

{% schema %}
{
  "name": "Scarcity Banner",
  "target": "section",
  "settings": [
    { "type": "select", "id": "notify_style", "label": "Notification Style", "options": [
      {"value": "spectacular", "label": "Spectacular"},
      {"value": "brutalist", "label": "Brutalist Bold"},
      {"value": "glassmorphism", "label": "Glassmorphism"},
      {"value": "christmas", "label": "Festive Christmas"},
      {"value": "blackweek", "label": "Blackweek"}
    ], "default": "spectacular" },
    { "type": "text", "id": "message", "label": "Message", "default": "Urgent: Limited time offer ending soon!" },
    { "type": "select", "id": "icon", "label": "Icon", "options": [
      {"value": "", "label": "No Icon"},
      {"value": "â†’", "label": "Arrow Right (â†’)"},
      {"value": "ğŸ›’", "label": "Shopping Cart (ğŸ›’)"},
      {"value": "ğŸ’", "label": "Diamond (ğŸ’)"},
      {"value": "âš¡", "label": "Lightning (âš¡)"},
      {"value": "ğŸ”¥", "label": "Fire (ğŸ”¥)"},
      {"value": "â­", "label": "Star (â­)"},
      {"value": "ğŸ¯", "label": "Target (ğŸ¯)"},
      {"value": "ğŸ’«", "label": "Dizzy Star (ğŸ’«)"},
      {"value": "ğŸš€", "label": "Rocket (ğŸš€)"},
      {"value": "âœ¨", "label": "Sparkles (âœ¨)"},
      {"value": "ğŸ’", "label": "Gift (ğŸ’)"},
      {"value": "ğŸ†", "label": "Trophy (ğŸ†)"},
      {"value": "ğŸ’°", "label": "Money Bag (ğŸ’°)"},
      {"value": "ğŸ‰", "label": "Party (ğŸ‰)"},
      {"value": "â¤ï¸", "label": "Heart (â¤ï¸)"},
      {"value": "ğŸ‘‘", "label": "Crown (ğŸ‘‘)"},
      {"value": "ğŸ", "label": "Present (ğŸ)"},
      {"value": "ğŸ’¯", "label": "Hundred (ğŸ’¯)"},
      {"value": "ğŸ””", "label": "Bell (ğŸ””)"}
    ], "default": "â†’" },
  ]
}
{% endschema %}
