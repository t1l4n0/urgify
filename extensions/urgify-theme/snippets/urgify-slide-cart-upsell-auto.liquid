{% comment %}
  Automatically injects the cart upsell block into the cart drawer
  when enabled via Admin UI settings. This avoids manual placement.
  
  Uses product metafields (urgify.cart_upsells) for upsell products.
  Configuration is loaded from database via backend endpoint.
  
  IMPORTANT: Only renders if explicitly enabled. If not enabled, nothing is rendered.
{% endcomment %}

{% liquid
  # Check if cart upsell is enabled via shop metafield (set by app when saving settings)
  assign cart_upsell_enabled = shop.metafields.urgify.cart_upsell_enabled.value | default: false
  
  # Also check if there's a config metafield (legacy support)
  assign cart_upsell_config = shop.metafields.urgify.cart_upsell_config.value | default: '{}'
  
  # Parse config if it exists
  if cart_upsell_config != '{}' and cart_upsell_config != ''
    # Try to extract enabled from JSON config
    assign config_enabled = false
    if cart_upsell_config contains '"enabled":true' or cart_upsell_config contains '"enabled": true'
      assign config_enabled = true
    endif
  endif
  
  # Only proceed if explicitly enabled
  if cart_upsell_enabled == true or cart_upsell_enabled == 'true' or config_enabled == true
    assign should_render = true
  else
    assign should_render = false
  endif
%}

{% if should_render %}
  {{ 'urgify-slide-cart-upsell.css' | asset_url | stylesheet_tag }}

  {% comment %}Config will be fetched by JavaScript from backend endpoint{% endcomment %}
  <script type="application/json" id="urgify-cart-upsell-config">{{ cart_upsell_config }}</script>

  <div 
    id="urgify-slide-cart-upsell-auto"
    class="urgify-slide-cart-upsell"
    data-urgify="slide-cart-upsell"
    data-block-id="auto"
    data-app-backend-url="https://urgify.fly.dev"
    style="display: none;"
  ></div>

  <script src="{{ 'urgify-slide-cart-upsell.js' | asset_url }}" defer></script>
{% else %}
  {% comment %}Cart Upsell is disabled - render nothing{% endcomment %}
{% endif %}

