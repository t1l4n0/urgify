{% comment %}
  Urgify Countdown Block - Enhanced with Countify functionality
  Advanced countdown timer with multiple styles and customization options
{% endcomment %}

{% liquid
  # Check subscription status first
  assign subscription_active = shop.metafields.urgify.subscription_active.value | default: false
  if subscription_active != true and subscription_active != 'true'
    # No active subscription, don't render anything
    assign should_render = false
  else
    assign should_render = true
  endif
  
  # Only proceed if subscription is active
  if should_render
    assign target_datetime = block.settings.end_datetime
    
    # Pr√ºfe ob Datum leer oder ung√ºltig ist
    assign has_valid_datetime = false
    if target_datetime != blank and target_datetime != empty and target_datetime != null and target_datetime != ''
      assign has_valid_datetime = true
    endif
  endif
  
  assign countdown_style_vars = ''
  assign countdown_background = block.settings.background_color | default: 'linear-gradient(135deg, #ff6b35 0%, #f7931e 100%)'
  assign countdown_border_radius = block.settings.border_radius | default: 12
  assign countdown_font_color = block.settings.font_color | default: '#ffffff'
  assign countdown_unit_bg = block.settings.unit_background_color | default: 'rgba(255, 255, 255, 0.15)'
  assign countdown_unit_border = block.settings.unit_border_color | default: 'rgba(255, 255, 255, 0.2)'
  assign countdown_value_color = block.settings.value_color | default: '#ffffff'
  assign countdown_label_color = block.settings.label_color | default: '#ffffff'
  assign countdown_value_font_size = block.settings.value_font_size | default: 2.8
  assign countdown_label_font_size = block.settings.label_font_size | default: 0.875
  assign countdown_progress_color = block.settings.progress_color | default: '#ffffff'
  assign countdown_expired_bg = block.settings.expired_background_color | default: 'rgba(255, 0, 0, 0.1)'
  assign countdown_expired_text = block.settings.expired_text_color | default: '#d32f2f'
  assign countdown_minimal_background = block.settings.background_color | default: 'transparent'
  assign countdown_minimal_text = block.settings.value_color | default: '#ffffff'
  assign countdown_minimal_separator = block.settings.value_color | default: '#ffffff'

  if has_valid_datetime
    if target_datetime contains ' '
      assign target_timestamp = target_datetime | replace: ' ', 'T' | append: ':00'
    else
      assign target_timestamp = target_datetime | append: 'T00:00:00'
    endif

    # epoch f√ºr JS als Fallback (Zahl, nicht String!)
    assign target_epoch_str = target_timestamp | date: '%s'
    assign target_epoch = target_epoch_str | plus: 0

    # Erstelle settings hash direkt
    assign settings_json = '{"target_datetime":"' | append: target_timestamp | append: '","target_epoch":' | append: target_epoch | append: ',"countdown_style":"' | append: block.settings.countdown_style | append: '","show_days":' | append: block.settings.show_days | append: ',"show_hours":' | append: block.settings.show_hours | append: ',"show_minutes":' | append: block.settings.show_minutes | append: ',"show_seconds":' | append: block.settings.show_seconds | append: ',"expired_message":"' | append: block.settings.expired_message | append: '","animation":"' | append: block.settings.animation | append: '"}'

  endif
%}

{{ 'urgify-countdown.css' | asset_url | stylesheet_tag }}

{% capture countdown_style_vars %}
{% if has_valid_datetime %}
--urgify-countdown-background: {{ countdown_background }};
--urgify-countdown-border-radius: {{ countdown_border_radius }}px;
--urgify-countdown-font-color: {{ countdown_font_color }};
--urgify-countdown-unit-bg: {{ countdown_unit_bg }};
--urgify-countdown-unit-border: {{ countdown_unit_border }};
--urgify-countdown-value-color: {{ countdown_value_color }};
--urgify-countdown-label-color: {{ countdown_label_color }};
--urgify-countdown-value-font-size: {{ countdown_value_font_size }}rem;
--urgify-countdown-label-font-size: {{ countdown_label_font_size }}rem;
--urgify-countdown-progress-color: {{ countdown_progress_color }};
--urgify-countdown-expired-bg: {{ countdown_expired_bg }};
--urgify-countdown-expired-text: {{ countdown_expired_text }};
--urgify-countdown-minimal-background: {{ countdown_minimal_background }};
--urgify-countdown-minimal-text: {{ countdown_minimal_text }};
--urgify-countdown-minimal-separator: {{ countdown_minimal_separator }};
{% endif %}
{% endcapture %}

{% unless should_render %}
  {% comment %}No active subscription - show subscription required message{% endcomment %}
  <div style="padding: 20px; border: 2px dashed #e74c3c; border-radius: 8px; margin: 20px 0; background: #fdf2f2; text-align: center;">
    <div style="color: #e74c3c; font-weight: bold; margin-bottom: 8px;">üîí Subscription Required</div>
    <div style="color: #666; font-size: 14px; margin-bottom: 12px;">This block requires an active Urgify subscription to display.</div>
    <div style="color: #999; font-size: 12px;">Configure your settings below. The block will appear once you subscribe.</div>
  </div>
{% elsif has_valid_datetime == false %}
<div style="padding:16px;border:1px dashed #ccc;border-radius:8px;margin:20px 0;">
  <strong>Countdown:</strong> Please set a target date in the block settings
  (Format: YYYY-MM-DD HH:MM).
</div>
{% else %}
     <!-- Ensure urgify.js is loaded as fallback -->
     <script>
       // Check if urgify.js is already loaded, if not load it
       if (!document.querySelector('script[src*="urgify.js"]') && 
           typeof window.__URGIFY_PRESENT__ === 'undefined') {
         var script = document.createElement('script');
         script.src = '{{ 'urgify.js' | asset_url }}';
         script.onerror = function() {
           if (window.UrgifyDebug) {
             console.error('Urgify: Failed to load fallback script');
           }
         };
         document.head.appendChild(script);
       }
     </script>

     <div id="urgify-countdown-{{ block.id }}"
          class="urgify-countdown countdown-theme-{{ block.settings.color_theme | default: 'primary' }}"
          data-urgify="countdown"
          data-block-id="{{ block.id }}"
          data-settings="{{ settings_json | escape }}"
          data-target-epoch="{{ target_epoch }}"
          data-target-datetime="{{ target_timestamp }}"
          style="display:block; {{ countdown_style_vars | strip | replace: '\n', ' ' }}">

{% if request.design_mode %}
<div style="padding: 20px; border: 2px dashed #ff6b35; border-radius: 8px; background: rgba(255, 107, 53, 0.05); margin: 20px 0;">
  <div style="color: #ff6b35; font-weight: bold; margin-bottom: 10px;">Urgify Countdown</div>
  <div style="color: #666; font-size: 14px;">
    {% if block.settings.end_datetime %}
      Target: {{ block.settings.end_datetime }}
    {% else %}
      No target date set
    {% endif %}
    </div>
  <div style="color: #666; font-size: 14px; margin-top: 5px;">
    Style: {{ block.settings.countdown_style | default: 'digital' | capitalize }}
    </div>
  {% if block.settings.color_theme == 'custom' %}
  <div style="color: #666; font-size: 14px; margin-top: 5px;">
    Background: {{ block.settings.background_color | default: 'Not set' }}
  </div>
  <div style="color: #666; font-size: 14px;">
    Font: {{ block.settings.font_color | default: 'Not set' }}
  </div>
  {% endif %}
    </div>
  {% endif %}

  <div class="countdown-container countdown-{{ block.settings.countdown_style | default: 'digital' }} countdown-theme-{{ block.settings.color_theme | default: 'primary' }} {{ block.settings.animation | default: 'none' }}">
    {% if block.settings.countdown_style == 'digital' %}
      <div class="countdown-digital">
        {% if block.settings.show_days %}
          <div class="countdown-unit">
            <div id="days-{{ block.id }}" class="countdown-value">00</div>
            <div class="countdown-label">Days</div>
          </div>
        {% endif %}
        {% if block.settings.show_hours %}
          <div class="countdown-unit">
            <div id="hours-{{ block.id }}" class="countdown-value">00</div>
            <div class="countdown-label">Hours</div>
          </div>
        {% endif %}
        {% if block.settings.show_minutes %}
          <div class="countdown-unit">
            <div id="minutes-{{ block.id }}" class="countdown-value">00</div>
            <div class="countdown-label">Min</div>
          </div>
        {% endif %}
        {% if block.settings.show_seconds %}
          <div class="countdown-unit">
            <div id="seconds-{{ block.id }}" class="countdown-value">00</div>
            <div class="countdown-label">Sec</div>
          </div>
        {% endif %}
      </div>
    {% elsif block.settings.countdown_style == 'flip' %}
      <div class="countdown-flip">
        {% if block.settings.show_days %}
          <div class="flip-card-wrapper">
            <div class="flip-card" data-days="{{ block.id }}">
              <div class="flip-card-inner">
                <div class="flip-card-front">
                  <div id="days-{{ block.id }}" class="flip-value">00</div>
                </div>
                <div class="flip-card-back">
                  <div id="days-{{ block.id }}-back" class="flip-value">00</div>
                </div>
              </div>
            </div>
            <div class="flip-label">Days</div>
          </div>
        {% endif %}
        {% if block.settings.show_hours %}
          <div class="flip-card-wrapper">
            <div class="flip-card" data-hours="{{ block.id }}">
              <div class="flip-card-inner">
                <div class="flip-card-front">
                  <div id="hours-{{ block.id }}" class="flip-value">00</div>
                </div>
                <div class="flip-card-back">
                  <div id="hours-{{ block.id }}-back" class="flip-value">00</div>
                </div>
              </div>
            </div>
            <div class="flip-label">Hours</div>
          </div>
        {% endif %}
        {% if block.settings.show_minutes %}
          <div class="flip-card-wrapper">
            <div class="flip-card" data-minutes="{{ block.id }}">
              <div class="flip-card-inner">
                <div class="flip-card-front">
                  <div id="minutes-{{ block.id }}" class="flip-value">00</div>
                </div>
                <div class="flip-card-back">
                  <div id="minutes-{{ block.id }}-back" class="flip-value">00</div>
                </div>
              </div>
            </div>
            <div class="flip-label">Min</div>
          </div>
        {% endif %}
        {% if block.settings.show_seconds %}
          <div class="flip-card-wrapper">
            <div class="flip-card" data-seconds="{{ block.id }}">
              <div class="flip-card-inner">
                <div class="flip-card-front">
                  <div id="seconds-{{ block.id }}" class="flip-value">00</div>
                </div>
                <div class="flip-card-back">
                  <div id="seconds-{{ block.id }}-back" class="flip-value">00</div>
                </div>
              </div>
            </div>
            <div class="flip-label">Sec</div>
          </div>
        {% endif %}
      </div>
    {% elsif block.settings.countdown_style == 'circular' %}
      <div class="countdown-circular">
        {% if block.settings.show_days %}
          <div class="circular-progress">
            <svg class="circular-svg">
              <circle class="circular-bg" cx="60" cy="60" r="52"></circle>
              <circle class="circular-progress-bar" cx="60" cy="60" r="52" data-days="{{ block.id }}"></circle>
            </svg>
            <div class="circular-content">
              <div id="days-{{ block.id }}" class="circular-value">00</div>
              <div class="circular-label">Days</div>
            </div>
          </div>
        {% endif %}
        {% if block.settings.show_hours %}
          <div class="circular-progress">
            <svg class="circular-svg">
              <circle class="circular-bg" cx="60" cy="60" r="52"></circle>
              <circle class="circular-progress-bar" cx="60" cy="60" r="52" data-hours="{{ block.id }}"></circle>
            </svg>
            <div class="circular-content">
              <div id="hours-{{ block.id }}" class="circular-value">00</div>
              <div class="circular-label">Hours</div>
            </div>
          </div>
        {% endif %}
        {% if block.settings.show_minutes %}
          <div class="circular-progress">
            <svg class="circular-svg">
              <circle class="circular-bg" cx="60" cy="60" r="52"></circle>
              <circle class="circular-progress-bar" cx="60" cy="60" r="52" data-minutes="{{ block.id }}"></circle>
            </svg>
            <div class="circular-content">
              <div id="minutes-{{ block.id }}" class="circular-value">00</div>
              <div class="circular-label">Min</div>
            </div>
          </div>
        {% endif %}
        {% if block.settings.show_seconds %}
          <div class="circular-progress">
            <svg class="circular-svg">
              <circle class="circular-bg" cx="60" cy="60" r="52"></circle>
              <circle class="circular-progress-bar" cx="60" cy="60" r="52" data-seconds="{{ block.id }}"></circle>
            </svg>
            <div class="circular-content">
              <div id="seconds-{{ block.id }}" class="circular-value">00</div>
              <div class="circular-label">Sec</div>
            </div>
          </div>
        {% endif %}
      </div>
    {% elsif block.settings.countdown_style == 'minimal' %}
      <div class="countdown-minimal">
        {% if block.settings.show_days %}
          <div class="minimal-unit">
            <div id="days-{{ block.id }}" class="minimal-value">00</div>
            <div class="minimal-label">d</div>
          </div>
          {% if block.settings.show_hours or block.settings.show_minutes or block.settings.show_seconds %}
            <div class="minimal-separator">:</div>
          {% endif %}
        {% endif %}
        {% if block.settings.show_hours %}
          <div class="minimal-unit">
            <div id="hours-{{ block.id }}" class="minimal-value">00</div>
            <div class="minimal-label">h</div>
          </div>
          {% if block.settings.show_minutes or block.settings.show_seconds %}
            <div class="minimal-separator">:</div>
          {% endif %}
        {% endif %}
        {% if block.settings.show_minutes %}
          <div class="minimal-unit">
            <div id="minutes-{{ block.id }}" class="minimal-value">00</div>
            <div class="minimal-label">m</div>
          </div>
          {% if block.settings.show_seconds %}
            <div class="minimal-separator">:</div>
          {% endif %}
        {% endif %}
        {% if block.settings.show_seconds %}
          <div class="minimal-unit">
            <div id="seconds-{{ block.id }}" class="minimal-value">00</div>
            <div class="minimal-label">s</div>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

        <script>
        // Countdown wird von Urgify.js automatisch initialisiert
        // Robuster Fallback mit Retry-Logic f√ºr den Fall, dass Urgify.js nicht geladen ist
        
        // Robusterer Check mit Retry-Logic
        function checkUrgifyLoaded(retries = 10, delay = 200) {
          if (typeof window.__URGIFY_PRESENT__ !== 'undefined' || 
              typeof window.Urgify !== 'undefined' ||
              typeof window.UrgifyCountdown !== 'undefined') {
            return;
          }
          
          if (retries > 0) {
            setTimeout(() => checkUrgifyLoaded(retries - 1, delay), delay);
          } else {
            if (window.UrgifyDebug) {
              console.warn('Urgify: Core script not loaded after retries - showing fallback message');
            }
            
            // Fallback: Countdown-Container sichtbar machen
            const countdownBlocks = document.querySelectorAll('[data-urgify="countdown"]');
            countdownBlocks.forEach(block => {
              const container = block.querySelector('.countdown-container');
              if (container) {
                container.style.opacity = '1';
                container.classList.add('is-ready');
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff6b35; font-weight: bold;">Countdown requires Urgify app to be loaded</div>';
              }
            });
          }
        }

        // Start check nach DOM ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => checkUrgifyLoaded());
        } else {
          checkUrgifyLoaded();
        }
</script>
{% endunless %}


{% schema %}
{
  "name": "Countdown",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "‚è∞ Countdown Settings",
      "info": "Add countdown timers for sales, launches, and limited offers."
    },
    {
      "type": "text",
      "id": "end_datetime",
      "label": "Target Date & Time",
      "default": "2025-12-23 23:59",
      "info": "The date and time when the countdown should end (Format: YYYY-MM-DD HH:MM). Example: 2025-12-23 23:59"
    },
    {
      "type": "text",
      "id": "expired_message",
      "label": "Expired Message",
      "default": "Time's up!",
      "info": "Message shown when countdown expires"
    },
    {
      "type": "header",
      "content": "üé® Style Settings"
    },
    {
      "type": "select",
      "id": "countdown_style",
      "label": "Countdown Style",
      "options": [
        { "value": "digital", "label": "Digital Clock" },
        { "value": "flip", "label": "Flip Cards" },
        { "value": "circular", "label": "Circular Progress" },
        { "value": "minimal", "label": "Minimal" }
      ],
      "default": "digital"
    },
    {
      "type": "select",
      "id": "color_theme",
      "label": "Color Theme",
      "options": [
        { "value": "primary", "label": "Primary" },
        { "value": "christmas", "label": "Festive Christmas" },
        { "value": "blackweek", "label": "Blackweek" },
        { "value": "success", "label": "Success" },
        { "value": "warning", "label": "Warning" },
        { "value": "danger", "label": "Danger" },
        { "value": "custom", "label": "Custom" }
      ],
      "default": "primary"
    },
    {
      "type": "select",
      "id": "animation",
      "label": "Animation",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "pulse", "label": "Pulse" },
        { "value": "fadeInUp", "label": "Fade In Up" },
        { "value": "slideIn", "label": "Slide In" }
      ],
      "default": "none"
    },
    {
      "type": "header",
      "content": "üìä Display Options"
    },
    {
      "type": "checkbox",
      "id": "show_days",
      "label": "Show Days",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_hours",
      "label": "Show Hours",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_minutes",
      "label": "Show Minutes",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_seconds",
      "label": "Show Seconds",
      "default": true
    },
    {
      "type": "header",
      "content": "üé® Custom Colors",
      "info": "These options are only available when Color Theme is set to 'Custom'",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#ff6b35",
      "alpha": false,
      "info": "Main background color for the countdown",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "color",
      "id": "font_color",
      "label": "Font Color",
      "default": "#ffffff",
      "alpha": false,
      "info": "Sets color for text and numbers",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "color",
      "id": "value_color",
      "label": "Value Color",
      "default": "#ffffff",
      "alpha": false,
      "info": "Color for countdown numbers",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "color",
      "id": "label_color",
      "label": "Label Color",
      "default": "#ffffff",
      "alpha": false,
      "info": "Color for countdown labels (Days, Hours, etc.)",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "color",
      "id": "unit_background_color",
      "label": "Unit Background Color",
      "default": "#ffffff",
      "alpha": false,
      "info": "Background color for individual countdown units",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "color",
      "id": "unit_border_color",
      "label": "Unit Border Color",
      "default": "#ffffff",
      "alpha": false,
      "info": "Border color for individual countdown units",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "color",
      "id": "progress_color",
      "label": "Progress Color (Circular)",
      "default": "#ffffff",
      "alpha": false,
      "info": "Color for circular progress bars",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "color",
      "id": "expired_background_color",
      "label": "Expired Background Color",
      "default": "rgba(255, 0, 0, 0.1)",
      "info": "Background color when countdown expires",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "color",
      "id": "expired_text_color",
      "label": "Expired Text Color",
      "default": "#d32f2f",
      "info": "Text color when countdown expires",
      "visible_if": "{{ block.settings.color_theme == 'custom' }}"
    },
    {
      "type": "header",
      "content": "üìè Typography"
    },
    {
      "type": "range",
      "id": "value_font_size",
      "label": "Value Font Size",
      "min": 1,
      "max": 4,
      "step": 0.1,
      "default": 2.5,
      "unit": "rem",
      "info": "Size of countdown numbers"
    },
    {
      "type": "range",
      "id": "label_font_size",
      "label": "Label Font Size",
      "min": 0.5,
      "max": 1.5,
      "step": 0.1,
      "default": 0.9,
      "unit": "rem",
      "info": "Size of countdown labels"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 30,
      "step": 1,
      "default": 12,
      "unit": "px",
      "info": "Roundness of countdown container corners"
    }
  ]
}
{% endschema %}
