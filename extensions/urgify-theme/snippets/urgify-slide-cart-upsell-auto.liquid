{% comment %}
  Automatically injects the cart upsell block into the cart drawer
  when enabled via Admin UI settings. This avoids manual placement.
  
  Uses product metafields (upsell.products) for upsell products.
  Configuration is loaded from shop metafield (urgify.cart_upsell_config).
{% endcomment %}

{% liquid
  # Get configuration from shop metafield
  assign cart_upsell_config = shop.metafields.urgify.cart_upsell_config.value | default: '{}'
  
  # Basic check if enabled (simplified JSON parsing in Liquid)
  # Check multiple variations of enabled:true in JSON
  assign config_enabled = false
  if cart_upsell_config != '{}' and cart_upsell_config != '' and cart_upsell_config != null
    # Check various formats of enabled:true (Liquid doesn't support 'or' in if, so check separately)
    if cart_upsell_config contains '"enabled":true'
      assign config_enabled = true
    elsif cart_upsell_config contains '"enabled": true'
      assign config_enabled = true
    elsif cart_upsell_config contains '"enabled":true,'
      assign config_enabled = true
    elsif cart_upsell_config contains '"enabled": true,'
      assign config_enabled = true
    elsif cart_upsell_config contains '"enabled":1'
      assign config_enabled = true
    elsif cart_upsell_config contains '"enabled": 1'
      assign config_enabled = true
    elsif cart_upsell_config contains 'enabled":true'
      assign config_enabled = true
    endif
  endif
%}

{% comment %}Only render if enabled - this prevents unnecessary script loading and initialization{% endcomment %}
{% if config_enabled %}
  {{ 'urgify-slide-cart-upsell.css' | asset_url | stylesheet_tag }}

  {% comment %}Store config in script tag for reliable JSON parsing{% endcomment %}
  {% comment %}Ensure we have valid JSON - if cart_upsell_config is empty or invalid, use empty object{% endcomment %}
  {% liquid
    assign safe_config = cart_upsell_config
    if safe_config == blank or safe_config == '' or safe_config == null
      assign safe_config = '{}'
    endif
    # Ensure it's valid JSON format (starts with { and ends with })
    unless safe_config contains '{'
      assign safe_config = '{}'
    endunless
  %}
  <script type="application/json" id="urgify-cart-upsell-config">{{ safe_config }}</script>

  <div 
    id="urgify-slide-cart-upsell-auto"
    class="urgify-slide-cart-upsell"
    data-urgify="slide-cart-upsell"
    data-block-id="auto"
    data-config-enabled="{{ config_enabled }}"
    style="display: none;"
  ></div>

  <script src="{{ 'urgify-slide-cart-upsell.js' | asset_url }}" defer></script>
{% endif %}

{% comment %}End of enabled check{% endcomment %}

