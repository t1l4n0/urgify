{% liquid
  # JSON-Config laden (kann fehlen)
  assign cfg_json = shop.metafields.urgify.stock_alert_config.value | default: '{}'
  
  # Einzel-Metafields → dann JSON → dann Default
  assign enabled = shop.metafields.urgify.stock_alert_enabled.value | default: true
  assign threshold = shop.metafields.urgify.global_threshold.value | default: 5
  assign low_msg = shop.metafields.urgify.low_stock_message.value | default: 'Only {{qty}} left in stock!'
  assign font_size = shop.metafields.urgify.font_size.value | default: '18px'
  assign text_color = shop.metafields.urgify.text_color.value | default: '#ffffff'
  assign background_color = shop.metafields.urgify.background_color.value | default: '#e74c3c'
  assign animation = shop.metafields.urgify.stock_counter_animation.value | default: 'pulse'
  assign position = shop.metafields.urgify.stock_counter_position.value | default: 'above'
%}

{%- comment -%} Varianten-Bestände als JSON ausgeben {%- endcomment -%}
<script type="application/json" id="urgify-variant-qty-{{ block.id }}">
{
{%- for v in product.variants -%}
  "{{ v.id }}": {{ v.inventory_quantity | default: 0 }}{% unless forloop.last %},{% endunless %}
{%- endfor -%}
}
</script>

{%- comment -%} Show block if enabled is true, or if no metafields are set yet (default to enabled) {%- endcomment -%}
{%- if enabled == true or enabled == 'true' or enabled == blank -%}
  <div id="urgify-stock-alert-{{ block.id }}"
       class="urgify-stock-alert"
       hidden
       data-threshold="{{ threshold | escape }}"
       data-low-message="{{ low_msg | escape }}"
       data-font-size="{{ font_size | escape }}"
       data-text-color="{{ text_color | escape }}"
       data-background-color="{{ background_color | escape }}"
       data-animation="{{ animation | escape }}"
       data-position="{{ position | escape }}">
    <style>
      #urgify-stock-alert-{{ block.id }} {
        background: {{ background_color | escape }} !important;
        color: {{ text_color | escape }};
        font-size: {{ font_size | escape }};
      }
    </style>
    <span class="urgify-stock-alert__text"></span>
  </div>
{%- endif -%}

<script src="{{ 'urgify-stock-alert.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Urgify – Stock Alert",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Urgify – Stock Alert Configuration",
      "info": "This block is controlled entirely from the Urgify Admin App. No additional settings needed here."
    },
    {
      "type": "paragraph",
      "content": "To configure stock alerts, go to your Urgify Admin App and adjust the global settings. This block will automatically display stock alerts based on your admin configuration."
    }
  ]
}
{% endschema %}