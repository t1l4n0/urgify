{% comment %}
  Automatically renders the stock alert block near the add-to-cart form
  when the app is enabled. This avoids manual placement.
{% endcomment %}

{% liquid
  # JSON-Config laden (kann fehlen)
  assign cfg_json = shop.metafields.urgify.stock_alert_config.value | default: '{}'
  
  # Einzel-Metafields → dann JSON → dann Default
  assign enabled = shop.metafields.urgify.stock_alert_enabled.value | default: true
  assign threshold = shop.metafields.urgify.global_threshold.value | default: 5
  assign low_msg = shop.metafields.urgify.low_stock_message.value | default: 'Only {{qty}} left in stock!'
  assign font_size = shop.metafields.urgify.font_size.value | default: '18px'
  assign text_color = shop.metafields.urgify.text_color.value | default: '#ffffff'
  assign background_color = shop.metafields.urgify.background_color.value | default: '#e74c3c'
  assign animation = shop.metafields.urgify.stock_counter_animation.value | default: 'pulse'
  assign position = shop.metafields.urgify.stock_counter_position.value | default: 'above'
  assign style = shop.metafields.urgify.stock_alert_style.value | default: 'spectacular'

  assign tracks_inventory = false
  for v in product.variants
    if v.inventory_management
      assign tracks_inventory = true
      break
    endif
  endfor
%}

<script type="application/json" id="urgify-variant-qty-auto">
{
{%- for v in product.variants -%}
  "{{ v.id }}": {{ v.inventory_quantity | default: 0 }}{% unless forloop.last %},{% endunless %}
{%- endfor -%}
}
</script>

{% if enabled == true or enabled == 'true' %}
  {{ 'urgify-stock-alert.css' | asset_url | stylesheet_tag }}
  <div id="urgify-stock-alert-auto" class="urgify-stock-alert urgify-stock-alert--{{ style }}" hidden
       data-threshold="{{ threshold | escape }}"
       data-low-message="{{ low_msg | escape }}"
       data-message="{{ low_msg | escape }}"
       data-font-size="{{ font_size | escape }}"
       data-text-color="{{ text_color | escape }}"
       data-background-color="{{ background_color | escape }}"
       data-animation="{{ animation | escape }}"
       data-position="{{ position | escape }}"
       data-style="{{ style | escape }}"
       data-tracks-inventory="{{ tracks_inventory }}">
    <style>
      #urgify-stock-alert-auto {
        {% if style == 'custom' %}
          --urgify-font-size: {{ font_size | escape }};
          --urgify-text-color: {{ text_color | escape }};
          --urgify-bg: {{ background_color | escape }};
          --urgify-border: {{ text_color | escape }};
        {% endif %}
      }
    </style>
    <span class="urgify-stock-alert__text"></span>
  </div>
{% endif %}

<script src="{{ 'urgify-stock-alert.js' | asset_url }}" defer></script>